"use client";

import React, { useState, useEffect } from "react";
import { useAuth } from "@/hooks/useAuth";
import { useRouter } from "next/navigation";
import { getDB } from "@/lib/firebase";
import { collection, getDocs, doc, setDoc, addDoc, deleteDoc } from "firebase/firestore";
import Link from "next/link";
import { NewPlayer, TeamMembership } from "@/types/migration";

interface Player {
  id: string;
  firstName?: string;
  lastName?: string;
  name?: string;
  teams?: string[];
  number?: number;
  position?: string;
  birthYear?: number;
  imageUrl?: string;
}

interface MigrationAnalysis {
  totalPlayers: number;
  playersWithTeams: number;
  teamDistribution: { [teamId: string]: number };
  duplicateNumbers: Array<{teamId: string, number: number, players: string[]}>;
  missingData: Array<{playerId: string, missing: string[]}>;
  multiTeamPlayers: Array<{player: Player, teams: string[]}>;
  issues: string[];
}

export default function MigrationAnalysisPage() {
  const { user, isAdmin, isLoading } = useAuth();
  const router = useRouter();
  const [players, setPlayers] = useState<Player[]>([]);
  const [matches, setMatches] = useState<any[]>([]);
  const [teams, setTeams] = useState<any[]>([]);
  const [analysis, setAnalysis] = useState<MigrationAnalysis | null>(null);
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [error, setError] = useState<string | null>(null);
  
  // Stany migracji
  const [isMigrating, setIsMigrating] = useState(false);
  const [migrationProgress, setMigrationProgress] = useState(0);
  const [migrationStatus, setMigrationStatus] = useState<string>("");
  const [isMigrated, setIsMigrated] = useState(false);
  
  // Stany przywracania kopii zapasowej
  const [isRestoring, setIsRestoring] = useState(false);
  const [restoreProgress, setRestoreProgress] = useState(0);
  const [restoreStatus, setRestoreStatus] = useState<string>("");
  
  // Stany usuwania nowej struktury
  const [isDeleting, setIsDeleting] = useState(false);
  const [deleteProgress, setDeleteProgress] = useState(0);
  const [deleteStatus, setDeleteStatus] = useState<string>("");

  useEffect(() => {
    if (!isLoading && (!user || !isAdmin)) {
      router.push("/login");
    }
  }, [user, isAdmin, isLoading, router]);

  const loadData = async () => {
    try {
      setIsAnalyzing(true);
      setError(null);



             // Pobierz zawodnik√≥w
       const playersSnapshot = await getDocs(collection(getDB(), "players"));
       const playersData = playersSnapshot.docs.map(doc => ({
         id: doc.id,
         ...doc.data()
       })) as Player[];

       // Pobierz mecze
       const matchesSnapshot = await getDocs(collection(getDB(), "matches"));
       const matchesData = matchesSnapshot.docs.map(doc => ({
         id: doc.id,
         ...doc.data()
       }));

       // Pobierz zespo≈Çy
       const teamsSnapshot = await getDocs(collection(getDB(), "teams"));
      const teamsData = teamsSnapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));

      setPlayers(playersData);
      setMatches(matchesData);
      setTeams(teamsData);

      

      // Przeprowad≈∫ analizƒô
      const analysisResult = analyzeData(playersData);
      setAnalysis(analysisResult);

    } catch (err) {
      console.error("‚ùå B≈ÇƒÖd podczas ≈Çadowania danych:", err);
      setError(err instanceof Error ? err.message : "Nieznany b≈ÇƒÖd");
    } finally {
      setIsAnalyzing(false);
    }
  };

  const analyzeData = (playersData: Player[]): MigrationAnalysis => {
    console.log("üîç Rozpoczynam analizƒô danych...");

    const issues: string[] = [];
    const stats = {
      totalPlayers: playersData.length,
      playersWithTeams: 0,
      teamDistribution: {} as { [teamId: string]: number },
      duplicateNumbers: [] as Array<{teamId: string, number: number, players: string[]}>,
      missingData: [] as Array<{playerId: string, missing: string[]}>,
      multiTeamPlayers: [] as Array<{player: Player, teams: string[]}>
    };

    const teamPlayerNumbers: { [teamId: string]: { [number: number]: string[] } } = {};

    for (const player of playersData) {
      // Sprawd≈∫ czy zawodnik ma zespo≈Çy
      if (!player.teams || player.teams.length === 0) {
        issues.push(`‚ö†Ô∏è Zawodnik ${getPlayerName(player)} (${player.id}) nie ma przypisanych zespo≈Ç√≥w`);
      } else {
        stats.playersWithTeams++;
        
        // Je≈õli zawodnik jest w wielu zespo≈Çach
        if (player.teams.length > 1) {
          stats.multiTeamPlayers.push({
            player: player,
            teams: player.teams
          });
        }
        
        // Statystyki zespo≈Ç√≥w
        for (const teamId of player.teams) {
          stats.teamDistribution[teamId] = (stats.teamDistribution[teamId] || 0) + 1;
          
          // Sprawd≈∫ duplikaty numer√≥w w zespo≈Çach
          if (player.number) {
            if (!teamPlayerNumbers[teamId]) {
              teamPlayerNumbers[teamId] = {};
            }
            if (!teamPlayerNumbers[teamId][player.number]) {
              teamPlayerNumbers[teamId][player.number] = [];
            }
            teamPlayerNumbers[teamId][player.number].push(getPlayerName(player));
          }
        }
      }

      // Sprawd≈∫ brakujƒÖce dane
      const missing: string[] = [];
      if (!player.firstName && !player.name) missing.push('firstName/name');
      if (!player.lastName && !player.name) missing.push('lastName');
      if (!player.number) missing.push('number');
      if (!player.position) missing.push('position');
      
      if (missing.length > 0) {
        stats.missingData.push({ playerId: player.id, missing });
      }
    }

    // Znajd≈∫ duplikaty numer√≥w w zespo≈Çach
    for (const [teamId, numbers] of Object.entries(teamPlayerNumbers)) {
      for (const [number, playersList] of Object.entries(numbers)) {
        if (playersList.length > 1) {
          stats.duplicateNumbers.push({
            teamId,
            number: parseInt(number),
            players: playersList
          });
        }
      }
    }

    return {
      ...stats,
      issues
    };
  };

  const getPlayerName = (player: Player): string => {
    if (player.firstName && player.lastName) {
      return `${player.firstName} ${player.lastName}`;
    }
    if (player.name) {
      return player.name;
    }
    return "Brak nazwy";
  };

  const createBackup = async () => {
    if (!players.length || !matches.length || !teams.length) {
      alert("Najpierw za≈Çaduj dane!");
      return;
    }

    try {
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
      
      const backupData = {
        timestamp,
        players,
        matches,
        teams,
        analysis
      };

      // Pobierz dane jako JSON
      const dataStr = JSON.stringify(backupData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      
      // Pobierz jako plik
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `backup-migration-analysis-${timestamp}.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);

      alert("‚úÖ Backup zosta≈Ç pobrany jako plik JSON");
    } catch (err) {
      console.error("‚ùå B≈ÇƒÖd podczas tworzenia backup:", err);
      alert("‚ùå B≈ÇƒÖd podczas tworzenia backup");
    }
  };

  // Funkcja przywracania danych z kopii zapasowej
  const restoreFromBackup = async (file: File) => {
    try {
      setIsRestoring(true);
      setRestoreProgress(0);
      setError(null);
      setRestoreStatus("Czytam plik kopii zapasowej...");

      // Odczytaj plik JSON
      const fileText = await file.text();
      const backupData = JSON.parse(fileText);

      // Walidacja formatu kopii zapasowej
      if (!backupData.players || !Array.isArray(backupData.players)) {
        throw new Error("Nieprawid≈Çowy format kopii zapasowej - brak danych zawodnik√≥w");
      }

      console.log(`üì• Znaleziono ${backupData.players.length} zawodnik√≥w w kopii zapasowej`);
      setRestoreStatus(`Przywracam ${backupData.players.length} zawodnik√≥w...`);

      const totalPlayers = backupData.players.length;
      let restoredPlayers = 0;

      // Przywr√≥ƒá zawodnik√≥w
      for (const player of backupData.players) {
        try {
          setRestoreStatus(`Przywracam zawodnika: ${getPlayerName(player)}`);

          // Zapisz zawodnika do kolekcji players
          await setDoc(doc(getDB(), "players", player.id), {
            ...player,
            // Upewnij siƒô ≈ºe teams to tablica
            teams: Array.isArray(player.teams) ? player.teams : [player.teams].filter(Boolean)
          });

          restoredPlayers++;
          const progress = Math.round((restoredPlayers / totalPlayers) * 100);
          setRestoreProgress(progress);

          console.log(`‚úÖ Przywr√≥cono zawodnika ${getPlayerName(player)} (${restoredPlayers}/${totalPlayers})`);

        } catch (playerError) {
          console.error(`‚ùå B≈ÇƒÖd podczas przywracania zawodnika ${getPlayerName(player)}:`, playerError);
          // Kontynuuj z nastƒôpnym zawodnikiem
        }
      }

      setRestoreStatus("‚úÖ Przywracanie zako≈Ñczone pomy≈õlnie!");
      console.log("üéâ Przywracanie danych zako≈Ñczone pomy≈õlnie!");
      
      // Od≈õwie≈º dane
      await loadData();
      
      alert(`üéâ Przywracanie zako≈Ñczone!\n\nPrzywr√≥cono ${restoredPlayers} zawodnik√≥w z kopii zapasowej.\n\nDane zosta≈Çy za≈Çadowane ponownie.`);

    } catch (err) {
      console.error("‚ùå B≈ÇƒÖd podczas przywracania kopii zapasowej:", err);
      setError(err instanceof Error ? err.message : "Nieznany b≈ÇƒÖd przywracania");
      setRestoreStatus("‚ùå Przywracanie nie powiod≈Ço siƒô!");
      alert("‚ùå B≈ÇƒÖd podczas przywracania kopii zapasowej: " + (err instanceof Error ? err.message : "Nieznany b≈ÇƒÖd"));
    } finally {
      setIsRestoring(false);
    }
  };

  // Handler dla wyboru pliku
  const handleFileSelect = (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (file) {
      if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
        alert("Proszƒô wybraƒá plik JSON z kopiƒÖ zapasowƒÖ");
        return;
      }

      if (confirm(`Czy na pewno chcesz przywr√≥ciƒá dane z pliku "${file.name}"?\n\nTo nadpisze istniejƒÖce dane zawodnik√≥w!`)) {
        restoreFromBackup(file);
      }
    }
    // Wyczy≈õƒá input ≈ºeby mo≈ºna by≈Ço wybraƒá ten sam plik ponownie
    event.target.value = '';
  };

  // Funkcja usuwania nowej struktury teams/{teamId}/members
  const deleteNewStructure = async () => {
    if (!confirm("Czy na pewno chcesz usunƒÖƒá WSZYSTKIE dane z kolekcji teams/{teamId}/members?\n\nTo spowoduje usuniƒôcie:\n- Wszystkich membership zawodnik√≥w\n- Wszystkich danych o przynale≈ºno≈õci do zespo≈Ç√≥w\n- Wszystkich numer√≥w zawodnik√≥w w zespo≈Çach\n\nTa operacja jest NIEODWRACALNA!")) {
      return;
    }

    if (!confirm("OSTATNIE OSTRZE≈ªENIE!\n\nUsuniƒôcie tej struktury oznacza powr√≥t do starej architektury.\n\nCzy na pewno chcesz kontynuowaƒá?")) {
      return;
    }

    try {
      setIsDeleting(true);
      setDeleteProgress(0);
      setError(null);
      setDeleteStatus("Skanowanie zespo≈Ç√≥w...");

      // 1. Pobierz wszystkie zespo≈Çy
      const teamsSnapshot = await getDocs(collection(getDB(), "teams"));
      
      if (teamsSnapshot.empty) {
        setDeleteStatus("Nie znaleziono zespo≈Ç√≥w do usuniƒôcia");
        alert("Nie znaleziono zespo≈Ç√≥w w bazie danych");
        return;
      }

      console.log(`üóëÔ∏è Znaleziono ${teamsSnapshot.docs.length} zespo≈Ç√≥w`);
      setDeleteStatus(`Znaleziono ${teamsSnapshot.docs.length} zespo≈Ç√≥w. Usuwam cz≈Çonk√≥w...`);

      const totalTeams = teamsSnapshot.docs.length;
      let processedTeams = 0;
      let totalMembersDeleted = 0;

      // 2. Dla ka≈ºdego zespo≈Çu usu≈Ñ wszystkich cz≈Çonk√≥w
      for (const teamDoc of teamsSnapshot.docs) {
        const teamId = teamDoc.id;
        
        try {
          setDeleteStatus(`Usuwam cz≈Çonk√≥w z zespo≈Çu: ${teamId}`);
          
          // Pobierz wszystkich cz≈Çonk√≥w tego zespo≈Çu
          const membersSnapshot = await getDocs(collection(getDB(), "teams", teamId, "members"));
          
          if (!membersSnapshot.empty) {
            console.log(`üóëÔ∏è Usuwam ${membersSnapshot.docs.length} cz≈Çonk√≥w z zespo≈Çu ${teamId}`);
            
            // Usu≈Ñ wszystkich cz≈Çonk√≥w
            await Promise.all(
              membersSnapshot.docs.map(async (memberDoc) => {
                await deleteDoc(memberDoc.ref);
                totalMembersDeleted++;
              })
            );
            
            console.log(`‚úÖ Usuniƒôto ${membersSnapshot.docs.length} cz≈Çonk√≥w z zespo≈Çu ${teamId}`);
          } else {
            console.log(`‚ÑπÔ∏è Zesp√≥≈Ç ${teamId} nie ma cz≈Çonk√≥w do usuniƒôcia`);
          }
          
          processedTeams++;
          const progress = Math.round((processedTeams / totalTeams) * 100);
          setDeleteProgress(progress);
          
        } catch (teamError) {
          console.error(`‚ùå B≈ÇƒÖd podczas usuwania cz≈Çonk√≥w z zespo≈Çu ${teamId}:`, teamError);
          // Kontynuuj z nastƒôpnym zespo≈Çem
        }
      }

      setDeleteStatus("‚úÖ Usuwanie zako≈Ñczone pomy≈õlnie!");
      console.log("üéâ Usuwanie nowej struktury zako≈Ñczone pomy≈õlnie!");
      
      // Od≈õwie≈º dane ≈ºeby pokazaƒá ≈ºe nowa struktura zosta≈Ça usuniƒôta
      await loadData();
      
      alert(`üéâ Usuwanie zako≈Ñczone!\n\nUsuniƒôto ${totalMembersDeleted} cz≈Çonk√≥w z ${processedTeams} zespo≈Ç√≥w.\n\nAplikacja powr√≥ci≈Ça do starej architektury.`);

    } catch (err) {
      console.error("‚ùå B≈ÇƒÖd podczas usuwania nowej struktury:", err);
      setError(err instanceof Error ? err.message : "Nieznany b≈ÇƒÖd usuwania");
      setDeleteStatus("‚ùå Usuwanie nie powiod≈Ço siƒô!");
      alert("‚ùå B≈ÇƒÖd podczas usuwania nowej struktury: " + (err instanceof Error ? err.message : "Nieznany b≈ÇƒÖd"));
    } finally {
      setIsDeleting(false);
    }
  };

  const runMigration = async () => {
    if (!players.length || !analysis) {
      alert("Najpierw przeprowad≈∫ analizƒô!");
      return;
    }

    if (!confirm("Czy na pewno chcesz uruchomiƒá migracjƒô?\n\nTo proces nieodwracalny. Upewnij siƒô, ≈ºe masz backup danych!")) {
      return;
    }

    try {
      setIsMigrating(true);
      setMigrationProgress(0);
      setError(null);

      console.log("üöÄ Rozpoczynam migracjƒô danych...");
      setMigrationStatus("Rozpoczynam migracjƒô...");

      const totalPlayers = players.length;
      let processedPlayers = 0;

      for (const oldPlayer of players) {
        try {
          setMigrationStatus(`Migrujƒô zawodnika: ${getPlayerName(oldPlayer)}`);

          // 1. Utw√≥rz nowego zawodnika w g≈Ç√≥wnej kolekcji players
          const now = new Date();
          const newPlayerData: Omit<NewPlayer, "id"> = {
            firstName: oldPlayer.firstName || (oldPlayer.name ? oldPlayer.name.split(' ')[0] : '') || 'Brak',
            lastName: oldPlayer.lastName || (oldPlayer.name ? oldPlayer.name.split(' ').slice(1).join(' ') : '') || 'imienia',
            name: oldPlayer.name, // Zachowaj dla kompatybilno≈õci
            birthYear: oldPlayer.birthYear,
            imageUrl: oldPlayer.imageUrl,
            position: oldPlayer.position || 'CB', // Domy≈õlna pozycja
            createdAt: now,
            updatedAt: now
          };

          // Usu≈Ñ puste pola
          Object.keys(newPlayerData).forEach(key => {
            if (newPlayerData[key as keyof typeof newPlayerData] === undefined) {
              delete newPlayerData[key as keyof typeof newPlayerData];
            }
          });

          // Zapisz nowego zawodnika (u≈ºywamy tego samego ID)
          await setDoc(doc(getDB(), "players", oldPlayer.id), newPlayerData);

          // 2. Utw√≥rz membership w ka≈ºdym zespole
          const teams = oldPlayer.teams || [];
          for (const teamId of teams) {
            const membershipData: TeamMembership = {
              playerId: oldPlayer.id,
              number: oldPlayer.number || 0, // Domy≈õlny numer
              joinDate: now,
              status: 'active',
              notes: `Zmigrowano z starej struktury ${now.toISOString()}`
            };

            // Zapisz membership w zespole
            await setDoc(doc(getDB(), "teams", teamId, "members", oldPlayer.id), membershipData);
          }

          processedPlayers++;
          const progress = Math.round((processedPlayers / totalPlayers) * 100);
          setMigrationProgress(progress);

          console.log(`‚úÖ Zmigrowano zawodnika ${getPlayerName(oldPlayer)} (${processedPlayers}/${totalPlayers})`);

        } catch (playerError) {
          console.error(`‚ùå B≈ÇƒÖd podczas migracji zawodnika ${getPlayerName(oldPlayer)}:`, playerError);
          throw new Error(`B≈ÇƒÖd migracji zawodnika ${getPlayerName(oldPlayer)}: ${playerError}`);
        }
      }

      setMigrationStatus("‚úÖ Migracja zako≈Ñczona pomy≈õlnie!");
      setIsMigrated(true);
      console.log("üéâ Migracja danych zako≈Ñczona pomy≈õlnie!");
      
      alert(`üéâ Migracja zako≈Ñczona!\n\nZmigrowano ${processedPlayers} zawodnik√≥w do nowej struktury.\n\nTeraz mo≈ºesz u≈ºywaƒá aplikacji z nowƒÖ architekturƒÖ.`);

    } catch (err) {
      console.error("‚ùå B≈ÇƒÖd podczas migracji:", err);
      setError(err instanceof Error ? err.message : "Nieznany b≈ÇƒÖd migracji");
      setMigrationStatus("‚ùå Migracja nie powiod≈Ça siƒô!");
    } finally {
      setIsMigrating(false);
    }
  };

  if (isLoading) {
    return <div style={{ padding: "20px" }}>≈Åadowanie...</div>;
  }

  if (!user || !isAdmin) {
    return (
      <div style={{ padding: "20px", textAlign: "center" }}>
        <h1>Brak uprawnie≈Ñ</h1>
        <p>Tylko administratorzy majƒÖ dostƒôp do analizy migracji.</p>
      </div>
    );
  }

  return (
    <div style={{ padding: "20px", maxWidth: "1200px", margin: "0 auto" }}>
      <div style={{ marginBottom: "20px" }}>
        <Link href="/admin" style={{ color: "#007bff", textDecoration: "none" }}>
          ‚Üê Powr√≥t do panelu admin
        </Link>
      </div>

      <h1>üîÑ Analiza danych przed migracjƒÖ</h1>
      
      {/* Wyja≈õnienie struktury danych */}
      <div style={{
        backgroundColor: "#e7f3ff",
        padding: "20px",
        borderRadius: "8px",
        marginBottom: "20px"
      }}>
        <h2>üìã R√≥≈ºnice miƒôdzy strukturami danych</h2>
        
        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "20px", marginTop: "15px" }}>
          <div style={{ backgroundColor: "#fff3cd", padding: "15px", borderRadius: "8px" }}>
            <h3>üóÇÔ∏è STARA STRUKTURA (aktualna)</h3>
            <code style={{ display: "block", whiteSpace: "pre-wrap", fontSize: "12px", backgroundColor: "#f8f9fa", padding: "10px", borderRadius: "4px" }}>
{`players/{playerId} {
  id: "abc123",
  firstName: "Jan",
  lastName: "Kowalski", 
  name: "Jan Kowalski",
  number: 10,
  position: "CM",
  teams: ["team1", "team2"],
  birthYear: 1995,
  imageUrl: "...",
  
  // DUPLIKATY DANYCH:
  actionsSent: [...],
  actionsReceived: [...],
  matchesInfo: [...]
}`}
            </code>
            <p style={{ marginTop: "10px", fontSize: "14px" }}>
              ‚ùå <strong>Problemy:</strong> Duplikaty danych, jeden numer dla wszystkich zespo≈Ç√≥w, 
              trudne zarzƒÖdzanie transferami
            </p>
          </div>
          
          <div style={{ backgroundColor: "#d4edda", padding: "15px", borderRadius: "8px" }}>
            <h3>üÜï NOWA STRUKTURA (po migracji)</h3>
            <code style={{ display: "block", whiteSpace: "pre-wrap", fontSize: "12px", backgroundColor: "#f8f9fa", padding: "10px", borderRadius: "4px" }}>
{`players/{playerId} {
  id: "abc123",
  firstName: "Jan",
  lastName: "Kowalski",
  name: "Jan Kowalski", 
  position: "CM",
  birthYear: 1995,
  imageUrl: "...",
  createdAt: timestamp,
  updatedAt: timestamp
}

teams/{teamId}/members/{playerId} {
  playerId: "abc123",
  number: 10,
  joinDate: timestamp,
  status: "active",
  notes: "..."
}`}
            </code>
            <p style={{ marginTop: "10px", fontSize: "14px" }}>
              ‚úÖ <strong>Korzy≈õci:</strong> Bez duplikat√≥w, r√≥≈ºne numery w r√≥≈ºnych zespo≈Çach, 
              historia transfer√≥w, lepsze zarzƒÖdzanie
            </p>
          </div>
        </div>
        
        <div style={{ marginTop: "20px", padding: "15px", backgroundColor: "#d1ecf1", borderRadius: "8px" }}>
          <h4>üîÑ Jak dzia≈Ça migracja:</h4>
          <ol>
            <li><strong>Przepisuje dane zawodnika</strong> do <code>players/</code> (bez numeru, bez teams)</li>
            <li><strong>Tworzy membership</strong> w ka≈ºdym zespole w <code>teams/&#123;teamId&#125;/members/</code></li>
            <li><strong>Hook hybrydowy</strong> ≈ÇƒÖczy dane z powrotem dla UI</li>
            <li><strong>Usuwa duplikaty</strong> actionsSent, actionsReceived, matchesInfo</li>
          </ol>
        </div>
      </div>
      
      <div style={{ marginBottom: "30px" }}>
        <button
          onClick={loadData}
          disabled={isAnalyzing}
          style={{
            padding: "10px 20px",
            backgroundColor: "#007bff",
            color: "white",
            border: "none",
            borderRadius: "4px",
            cursor: isAnalyzing ? "not-allowed" : "pointer",
            marginRight: "10px"
          }}
        >
          {isAnalyzing ? "Analizujƒô..." : "üîç Przeprowad≈∫ analizƒô"}
        </button>

        {analysis && (
          <>
            <button
              onClick={createBackup}
              style={{
                padding: "10px 20px",
                backgroundColor: "#28a745",
                color: "white",
                border: "none",
                borderRadius: "4px",
                cursor: "pointer",
                marginRight: "10px"
              }}
            >
              üíæ Pobierz backup
            </button>
            
            <label
              style={{
                padding: "10px 20px",
                backgroundColor: "#ffc107",
                color: "black",
                border: "none",
                borderRadius: "4px",
                cursor: "pointer",
                marginRight: "10px",
                display: "inline-block"
              }}
            >
              üì• Przywr√≥ƒá z backup
              <input
                type="file"
                accept=".json"
                onChange={handleFileSelect}
                disabled={isRestoring}
                style={{
                  display: "none"
                }}
              />
            </label>
            
            <button
              onClick={deleteNewStructure}
              disabled={isDeleting}
              style={{
                padding: "10px 20px",
                backgroundColor: isDeleting ? "#6c757d" : "#dc3545",
                color: "white",
                border: "none",
                borderRadius: "4px",
                cursor: isDeleting ? "not-allowed" : "pointer",
                marginRight: "10px"
              }}
            >
              {isDeleting ? "üóëÔ∏è Usuwam..." : "üóëÔ∏è Usu≈Ñ nowƒÖ strukturƒô"}
            </button>
            
            {analysis.issues.length === 0 && !isMigrated && (
              <button
                onClick={runMigration}
                disabled={isMigrating}
                style={{
                  padding: "10px 20px",
                  backgroundColor: isMigrating ? "#6c757d" : "#dc3545",
                  color: "white",
                  border: "none",
                  borderRadius: "4px",
                  cursor: isMigrating ? "not-allowed" : "pointer"
                }}
              >
                {isMigrating ? "üîÑ Migrujƒô..." : "üöÄ Uruchom migracjƒô"}
              </button>
            )}

            {isMigrated && (
              <span style={{
                padding: "10px 20px",
                backgroundColor: "#d4edda",
                color: "#155724",
                border: "1px solid #c3e6cb",
                borderRadius: "4px",
                fontWeight: "bold"
              }}>
                ‚úÖ Migracja zako≈Ñczona!
              </span>
            )}
          </>
        )}
      </div>

      {error && (
        <div style={{ 
          backgroundColor: "#f8d7da", 
          color: "#721c24", 
          padding: "15px", 
          borderRadius: "4px", 
          marginBottom: "20px" 
        }}>
          ‚ùå B≈ÇƒÖd: {error}
        </div>
      )}

      {/* Pasek postƒôpu przywracania */}
      {isRestoring && (
        <div style={{ 
          backgroundColor: "#fff3cd", 
          padding: "20px", 
          borderRadius: "8px", 
          marginBottom: "20px" 
        }}>
          <h3>üì• Przywracanie kopii zapasowej</h3>
          <p><strong>Status:</strong> {restoreStatus}</p>
          <div style={{ 
            width: "100%", 
            backgroundColor: "#e9ecef", 
            borderRadius: "4px", 
            overflow: "hidden",
            marginTop: "10px"
          }}>
            <div style={{
              width: `${restoreProgress}%`,
              height: "20px",
              backgroundColor: "#ffc107",
              transition: "width 0.3s ease"
            }} />
          </div>
          <p style={{ marginTop: "5px", fontSize: "0.9em" }}>{restoreProgress}% zako≈Ñczone</p>
        </div>
      )}

      {/* Pasek postƒôpu usuwania */}
      {isDeleting && (
        <div style={{ 
          backgroundColor: "#f8d7da", 
          padding: "20px", 
          borderRadius: "8px", 
          marginBottom: "20px" 
        }}>
          <h3>üóëÔ∏è Usuwanie nowej struktury</h3>
          <p><strong>Status:</strong> {deleteStatus}</p>
          <div style={{ 
            width: "100%", 
            backgroundColor: "#e9ecef", 
            borderRadius: "4px", 
            overflow: "hidden",
            marginTop: "10px"
          }}>
            <div style={{
              width: `${deleteProgress}%`,
              height: "20px",
              backgroundColor: "#dc3545",
              transition: "width 0.3s ease"
            }} />
          </div>
          <p style={{ marginTop: "5px", fontSize: "0.9em" }}>{deleteProgress}% zako≈Ñczone</p>
        </div>
      )}

      {/* Pasek postƒôpu migracji */}
      {isMigrating && (
        <div style={{ 
          backgroundColor: "#e7f3ff", 
          padding: "20px", 
          borderRadius: "8px", 
          marginBottom: "20px" 
        }}>
          <h3>üöÄ Migracja w toku...</h3>
          <p><strong>Status:</strong> {migrationStatus}</p>
          <div style={{ 
            width: "100%", 
            backgroundColor: "#e9ecef", 
            borderRadius: "4px", 
            overflow: "hidden",
            marginTop: "10px"
          }}>
            <div style={{
              width: `${migrationProgress}%`,
              height: "20px",
              backgroundColor: "#007bff",
              transition: "width 0.3s ease"
            }} />
          </div>
          <p style={{ marginTop: "5px", fontSize: "0.9em" }}>{migrationProgress}% zako≈Ñczone</p>
        </div>
      )}

      {analysis && (
        <div>
          <h2>üìä Wyniki analizy</h2>
          
          {/* Przyk≈Çad transformacji danych */}
          {players.length > 0 && (
            <div style={{ 
              backgroundColor: "#f8f9fa", 
              padding: "20px", 
              borderRadius: "8px", 
              marginBottom: "20px" 
            }}>
              <h3>üîç Przyk≈Çad transformacji danych</h3>
              <p>Tak bƒôdzie wyglƒÖdaƒá transformacja pierwszego zawodnika:</p>
              
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "20px", marginTop: "15px" }}>
                <div>
                  <h4 style={{ color: "#856404" }}>PRZED migracjƒÖ (stara struktura):</h4>
                  <code style={{ display: "block", whiteSpace: "pre-wrap", fontSize: "11px", backgroundColor: "#fff3cd", padding: "10px", borderRadius: "4px" }}>
                    {JSON.stringify({
                      id: players[0].id,
                      firstName: players[0].firstName,
                      lastName: players[0].lastName,
                      name: players[0].name,
                      number: players[0].number,
                      position: players[0].position,
                      teams: players[0].teams,
                      birthYear: players[0].birthYear,
                      imageUrl: players[0].imageUrl ? "url..." : undefined
                    }, null, 2)}
                  </code>
                </div>
                
                <div>
                  <h4 style={{ color: "#155724" }}>PO migracji (nowa struktura):</h4>
                  <div style={{ fontSize: "11px" }}>
                    <div style={{ marginBottom: "10px" }}>
                      <strong>players/{players[0].id}</strong>
                      <code style={{ display: "block", whiteSpace: "pre-wrap", backgroundColor: "#d4edda", padding: "8px", borderRadius: "4px" }}>
                        {JSON.stringify({
                          id: players[0].id,
                          firstName: players[0].firstName || (players[0].name ? players[0].name.split(' ')[0] : 'Brak'),
                          lastName: players[0].lastName || (players[0].name ? players[0].name.split(' ').slice(1).join(' ') : 'imienia'),
                          name: players[0].name,
                          position: players[0].position || 'CB',
                          birthYear: players[0].birthYear,
                          imageUrl: players[0].imageUrl,
                          createdAt: "timestamp",
                          updatedAt: "timestamp"
                        }, null, 2)}
                      </code>
                    </div>
                    
                    {players[0].teams && players[0].teams.map(teamId => (
                      <div key={teamId} style={{ marginBottom: "8px" }}>
                        <strong>teams/{teamId}/members/{players[0].id}</strong>
                        <code style={{ display: "block", whiteSpace: "pre-wrap", backgroundColor: "#d1ecf1", padding: "8px", borderRadius: "4px" }}>
                          {JSON.stringify({
                            playerId: players[0].id,
                            number: players[0].number || 0,
                            joinDate: "timestamp",
                            status: "active",
                            notes: "Zmigrowano z starej struktury"
                          }, null, 2)}
                        </code>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          )}
          
          {/* Og√≥lne statystyki */}
          <div style={{ 
            backgroundColor: "#e7f3ff", 
            padding: "20px", 
            borderRadius: "8px", 
            marginBottom: "20px" 
          }}>
            <h3>üìà Og√≥lne statystyki</h3>
            <p><strong>Zawodnik√≥w og√≥≈Çem:</strong> {analysis.totalPlayers}</p>
            <p><strong>Zawodnik√≥w z zespo≈Çami:</strong> {analysis.playersWithTeams}</p>
            <p><strong>Zawodnik√≥w bez zespo≈Ç√≥w:</strong> {analysis.totalPlayers - analysis.playersWithTeams}</p>
            <p><strong>Zawodnik√≥w w wielu zespo≈Çach:</strong> {analysis.multiTeamPlayers.length}</p>
          </div>

          {/* Rozk≈Çad zespo≈Ç√≥w */}
          <div style={{ 
            backgroundColor: "#fff3cd", 
            padding: "20px", 
            borderRadius: "8px", 
            marginBottom: "20px" 
          }}>
            <h3>üèÜ Rozk≈Çad w zespo≈Çach</h3>
            {Object.entries(analysis.teamDistribution).map(([teamId, count]) => (
              <p key={teamId}><strong>{teamId}:</strong> {count} zawodnik√≥w</p>
            ))}
          </div>

          {/* Zawodnicy w wielu zespo≈Çach */}
          {analysis.multiTeamPlayers.length > 0 && (
            <div style={{ 
              backgroundColor: "#d1ecf1", 
              padding: "20px", 
              borderRadius: "8px", 
              marginBottom: "20px" 
            }}>
              <h3>üë• Zawodnicy w wielu zespo≈Çach ({analysis.multiTeamPlayers.length})</h3>
              {analysis.multiTeamPlayers.map(({ player, teams }) => (
                <div key={player.id} style={{ marginBottom: "10px", padding: "10px", backgroundColor: "white", borderRadius: "4px" }}>
                  <strong>{getPlayerName(player)}</strong> (#{player.number})
                  <br />
                  <span style={{ color: "#666" }}>Zespo≈Çy: {teams.join(", ")}</span>
                  <br />
                  <span style={{ fontSize: "0.9em", color: "#888" }}>ID: {player.id}</span>
                </div>
              ))}
            </div>
          )}

          {/* Duplikaty numer√≥w */}
          {analysis.duplicateNumbers.length > 0 && (
            <div style={{ 
              backgroundColor: "#f8d7da", 
              padding: "20px", 
              borderRadius: "8px", 
              marginBottom: "20px" 
            }}>
              <h3>‚ö†Ô∏è Duplikaty numer√≥w w zespo≈Çach</h3>
              {analysis.duplicateNumbers.map((dup, index) => (
                <p key={index}>
                  <strong>Zesp√≥≈Ç {dup.teamId}, numer {dup.number}:</strong> {dup.players.join(", ")}
                </p>
              ))}
            </div>
          )}

          {/* BrakujƒÖce dane */}
          {analysis.missingData.length > 0 && (
            <div style={{ 
              backgroundColor: "#f8d7da", 
              padding: "20px", 
              borderRadius: "8px", 
              marginBottom: "20px" 
            }}>
              <h3>‚ùå BrakujƒÖce dane</h3>
              {analysis.missingData.slice(0, 10).map((item, index) => (
                <p key={index}>
                  <strong>{item.playerId}:</strong> brak {item.missing.join(", ")}
                </p>
              ))}
              {analysis.missingData.length > 10 && (
                <p><em>... i {analysis.missingData.length - 10} wiƒôcej problem√≥w</em></p>
              )}
            </div>
          )}

          {/* Problemy */}
          {analysis.issues.length > 0 && (
            <div style={{ 
              backgroundColor: "#f8d7da", 
              padding: "20px", 
              borderRadius: "8px", 
              marginBottom: "20px" 
            }}>
              <h3>üö® Znalezione problemy</h3>
              {analysis.issues.slice(0, 10).map((issue, index) => (
                <p key={index}>{issue}</p>
              ))}
              {analysis.issues.length > 10 && (
                <p><em>... i {analysis.issues.length - 10} wiƒôcej problem√≥w</em></p>
              )}
            </div>
          )}

          {/* Podsumowanie gotowo≈õci */}
          <div style={{ 
            backgroundColor: analysis.issues.length === 0 ? "#d4edda" : "#fff3cd", 
            padding: "20px", 
            borderRadius: "8px", 
            marginBottom: "20px" 
          }}>
            <h3>üéØ Ocena gotowo≈õci do migracji</h3>
            {analysis.issues.length === 0 ? (
              <div>
                <p style={{ color: "#155724", fontWeight: "bold" }}>‚úÖ Dane sƒÖ gotowe do migracji!</p>
                <p>Wszyscy zawodnicy majƒÖ przypisane zespo≈Çy i podstawowe dane.</p>
                <p><strong>Korzy≈õci migracji:</strong></p>
                <ul>
                  <li>Zawodnicy w {analysis.multiTeamPlayers.length} przypadkach bƒôdƒÖ mogli mieƒá r√≥≈ºne numery w r√≥≈ºnych zespo≈Çach</li>
                  <li>Lepsze zarzƒÖdzanie statusem cz≈Çonkostwa (aktywny/wypo≈ºyczony/zawieszony)</li>
                  <li>Szybsze zapytania do bazy danych</li>
                  <li>Historia transfer√≥w i dat do≈ÇƒÖczenia do zespo≈Ç√≥w</li>
                </ul>
              </div>
            ) : (
              <div>
                <p style={{ color: "#856404", fontWeight: "bold" }}>‚ö†Ô∏è Znaleziono {analysis.issues.length} problem√≥w</p>
                <p>Zalecane jest naprawienie kluczowych problem√≥w przed migracjƒÖ.</p>
              </div>
            )}
          </div>

          <div style={{ 
            backgroundColor: "#e2e3e5", 
            padding: "20px", 
            borderRadius: "8px" 
          }}>
            <h3>üìù Nastƒôpne kroki</h3>
            <ol>
              <li>Pobierz backup danych (przycisk powy≈ºej)</li>
              <li>Je≈õli analiza pokazuje gotowo≈õƒá - mo≈ºesz przej≈õƒá do migracji</li>
              <li>Je≈õli sƒÖ problemy - popraw je w aplikacji i pon√≥w analizƒô</li>
              <li>Migracja zachowa wszystkich zawodnik√≥w w wielu zespo≈Çach</li>
              <li>Po migracji ka≈ºdy zesp√≥≈Ç bƒôdzie mia≈Ç swoje subcollection members/</li>
            </ol>
          </div>
          
          <div style={{ 
            backgroundColor: "#d1ecf1", 
            padding: "20px", 
            borderRadius: "8px",
            marginTop: "20px"
          }}>
            <h3>üîÑ Hook hybrydowy - jak dzia≈Ça po migracji</h3>
            <p>Po migracji aplikacja u≈ºywa "hooka hybrydowego" kt√≥ry:</p>
            <ul>
              <li>üîç <strong>Najpierw sprawdza</strong> czy istniejƒÖ dane w nowej strukturze <code>teams/*/members/</code></li>
              <li>üìä <strong>≈ÅƒÖczy dane</strong> z <code>players/</code> (imiƒô, nazwisko, pozycja) + <code>teams/*/members/</code> (numer, status)</li>
              <li>üîÑ <strong>Je≈õli nowa struktura pusta</strong>, u≈ºywa starej struktury <code>players.teams[]</code> jako fallback</li>
              <li>üéØ <strong>Zwraca do UI</strong> standardowy format Player - UI nie wie z jakiej struktury pochodzƒÖ dane</li>
            </ul>
            
            <div style={{ marginTop: "15px", padding: "15px", backgroundColor: "#f8f9fa", borderRadius: "4px" }}>
              <h4>üõ°Ô∏è Bezpieczne przej≈õcie:</h4>
              <p>Dziƒôki temu rozwiƒÖzaniu:</p>
              <ul>
                <li>‚úÖ Aplikacja dzia≈Ça przed, podczas i po migracji</li>
                <li>‚úÖ Mo≈ºesz przywr√≥ciƒá stare dane z backup je≈õli potrzebujesz</li>
                <li>‚úÖ Nie ma ryzyka utraty danych</li>
                <li>‚úÖ Stopniowe przej≈õcie na nowƒÖ architekturƒô</li>
              </ul>
            </div>
          </div>
        </div>
      )}
    </div>
  );
} 